#
# SQL queries for DjVu files of
# Genealogie Wiki https://wiki.genealogy.net
# WF 2025-02-28
#

# --- Migration federation queries (run against djvu_migrate in-memory db) ---
# Tables loaded by DjVuMigration.prepare(): djvu, mw_images, wiki

# Stats for the djvu table (extracted from DjVu SQLite)
'djvu_stats':
  param_list:
  sql: |
    SELECT
      count(*) as files,
      min(iso_date) as oldest,
      max(iso_date) as newest,
      max(page_count) as max_pages,
      round(avg(page_count), 1) as avg_pages,
      max(filesize) as max_filesize,
      round(avg(filesize), 0) as avg_filesize
    FROM djvu

# Stats for the mw_images table (extracted from MediaWiki API cache)
'mw_images_stats':
  param_list:
  sql: |
    SELECT
      count(*) as files,
      min(timestamp) as oldest,
      max(timestamp) as newest
    FROM mw_images

# Stats for the wiki table (extracted from MariaDB)
'wiki_stats':
  param_list:
  sql: |
    SELECT
      count(*) as files,
      min(oldest) as oldest,
      max(newest) as newest
    FROM wiki

# Federated: mw_images entries not present in djvu (join on relpath = path)
'mw_images_not_in_djvu':
  param_list:
    - name: limit
      type: int
      default_value: 10
  sql: |
    SELECT m.relpath, m.filename, m.timestamp, m.size
    FROM mw_images m
    LEFT JOIN djvu d ON m.relpath = d.path
    WHERE d.path IS NULL
    ORDER BY m.relpath
    LIMIT {{ limit }}

# Federated: djvu entries not present in mw_images (join on path = relpath)
'djvu_not_in_mw_images':
  param_list:
    - name: limit
      type: int
      default_value: 10
  sql: |
    SELECT d.path, d.iso_date, d.filesize, d.page_count
    FROM djvu d
    LEFT JOIN mw_images m ON d.path = m.relpath
    WHERE m.relpath IS NULL
    ORDER BY d.path
    LIMIT {{ limit }}

# --- DjVu SQLite queries (run against the real DjVu SQLite db via DjVuManager) ---

# Gesamtanzahl der Dateien und Seiten ermitteln
'total':
  param_list:
  sql: |
    SELECT
      count(*) as files,
      sum(page_count) as pages
    FROM DjVu

# Bilder nach DPI zählen
'dpi':
  param_list:
  sql: |
    SELECT count(*), dpi
    FROM Page
    GROUP BY dpi

# Seitenanzahl-Informationen
'page_and_size':
  param_list:
  sql: |
    SELECT
      path,
      page_count,
      filesize
    FROM DjVu
    ORDER BY page_count DESC,filesize DESC

# Sizes and compression ratio for bundled files
'bundled_sizes_and_ratio':
  param_list:
  sql: |
    SELECT
      ROUND(SUM(filesize)/1024/1024/1024.0, 1) AS total_djvu_gb,
      ROUND(SUM(package_filesize)/1024/1024/1024.0, 1) AS total_package_gb,
      ROUND(CAST(SUM(package_filesize) AS REAL) / SUM(filesize), 1) AS average_ratio
    FROM DjVu
    WHERE bundled = 1

# Alle DjVu-Datensätze abrufen
'all_djvu':
  param_list:
    - name: limit
      type: int
      default_value: 10000
  sql: |
    SELECT
      *
    FROM DjVu
    ORDER BY page_count
    LIMIT {{ limit }}

# Einen DjVu-Datensatz für einen path abrufen
'djvu_for_path':
  param_list:
    - name: path
      type: str
      default_value: "/images/1/1e/AB1953-Gohr.djvu"
  sql: |
    SELECT
      *
    FROM DjVu
    WHERE path= "{{ path }}"

# Alle Bild-Datensätze mit konfigurierbarem Limit abrufen
'all_pages':
  param_list:
    - name: limit
      type: int
      default_value: 50
  sql: |
    SELECT
      *
    FROM page
    ORDER BY path
    LIMIT {{ limit }}

# Alle Bild-Datensätze für einen Pfad mit konfigurierbarem Limit abrufen
'all_pages_for_path':
  param_list:
    - name: limit
      type: int
      default_value: 50
    - name: djvu_path
      type: str
      default_value: "/images/1/1e/AB1953-Gohr.djvu"
  sql: |
    SELECT
      *
    FROM page
    WHERE djvu_path= "{{ djvu_path }}"
    ORDER BY page_index
    LIMIT {{ limit }}

# Seiten nach DjVu-Pfad abrufen
'pages_of_djvu':
  param_list:
    - name: djvu_path
      type: text
      default_value: /images//a/a1/Treuen-Vogtland-AB-1905.djvu
  sql: |
    SELECT
      *
    FROM page
    WHERE djvu_path = "{{ djvu_path }}"
    ORDER BY page_index

# Gültige und ungültige Seiten pro DjVu zählen
'djvu_by_valid_pages':
  param_list:
  sql: |
    SELECT
      djvu_path,
      COUNT(*) as total_pages,
      SUM(CASE WHEN valid THEN 1 ELSE 0 END) as valid_pages,
      SUM(CASE WHEN NOT valid THEN 1 ELSE 0 END) as invalid_pages
    FROM page
    GROUP BY djvu_path
    ORDER BY valid_pages DESC
